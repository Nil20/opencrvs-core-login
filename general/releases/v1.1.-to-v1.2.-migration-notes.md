# v1.1.\* to v1.2.\* Migration notes



{% hint style="warning" %}
If you are working on behalf of a government that is considering implementing OpenCRVS, we can help you to migrate your version of OpenCRVS.&#x20;

Please contact us at [team@opencrvs.org](mailto:team@opencrvs.org?subject:WebsiteEnquiry)
{% endhint %}

We have worked hard to ensure that migrating from v1.1 to v1.2.\* is as easy as possible.  The most complex task really depends upon how much customisation you have made to your country configuration fork as you will be required to merge or rebase your fork with our release branch.  **(You must be familiar with the concept of** [**Git merge**](https://git-scm.com/docs/git-merge) **or**  [**Git rebase**](https://www.atlassian.com/git/tutorials/rewriting-history/git-rebase)**)**. Please refer to the [release notes](v1.1.0-release-notes.md) and our [release process including Gitflow](./) branching approach.

{% hint style="info" %}
Replace the \* with the latest minor hotfix release. &#x20;

As of December 2022 the latest release is: **v1.2.0-beta**
{% endhint %}

### Step 1: Upgrade your code

1. Navigate to your opencrvs-core directory, checkout the **release-v1.2.0-beta** or **master** branch and pull latest changes.  Yarn install any dependency upgrades:

```
cd <path on your environment>/opencrvs-core
```

```
git fetch
```

```
git checkout release-v1.2.*

or 

git checkout master (Always aligned to the latest release)
```

```
git pull
```

```
yarn --force
```

2\. You will now have the release code.  Your next step is to merge or rebase any changes you need from the country configuration repository fork.

3\. Navigate to your forked country configuration repo

```
cd <path on your environment>/opencrvs-<your country>
```

4\. Ensure that the branches you have set up are ready according to the new forking instructions [here](../../setup/3.-installation/3.2-set-up-your-own-country-configuration/3.2.1-fork-your-own-country-configuration-repository.md).  Specifically from [step 9 to 17](../../setup/3.-installation/3.2-set-up-your-own-country-configuration/3.2.1-fork-your-own-country-configuration-repository.md).

{% hint style="info" %}
If you have made no customisations to the Farajaland country configuration, other than updating your csv files for [administrative divisions](../../setup/3.-installation/3.2-set-up-your-own-country-configuration/3.2.2-set-up-administrative-address-divisions/), [offices and health facilities](../../setup/3.-installation/3.2-set-up-your-own-country-configuration/3.2.4-set-up-employees-for-testing-or-production/3.2.3.2-prepare-source-file-for-production-employees.md), [employees](../../setup/3.-installation/3.2-set-up-your-own-country-configuration/3.2.4-set-up-employees-for-testing-or-production/) and created new [backups](../../setup/3.-installation/3.2-set-up-your-own-country-configuration/3.2.6-create-factory-reset-reference-data-backups.md), the merge or rebase process should be easy.  If you have customised any routes or developed new API integrations, you may need to be a bit more careful with merging conflicts.
{% endhint %}

5\. Fetch all our latest branches as [**step 17 will have added Farajaland as a remote**](../../setup/3.-installation/3.2-set-up-your-own-country-configuration/3.2.1-fork-your-own-country-configuration-repository.md):

```
git fetch --all
```

6\. Checkout your **master-\<your country code>** branch, and merge or rebase from our release. ****&#x20;

{% hint style="info" %}
**It is generally easier to**[ **merge than rebase (advanced)**](https://www.atlassian.com/git/tutorials/merging-vs-rebasing)**.**
{% endhint %}

{% hint style="warning" %}
Merge/Rebase note: Prioritise your current backup zip files over our incoming Farajaland backups otherwise you will need to [regenerate your backups](../../setup/3.-installation/3.2-set-up-your-own-country-configuration/3.2.6-create-factory-reset-reference-data-backups.md) after the process ends.  Prioritise incoming changes for any other conflicts and refactor your code if you have developed your own customisations. Refer to our [release notes ](v1.2.0-beta-release-notes.md)for hints and any new translation keys that you will need to fix conflicts for.
{% endhint %}

```
git checkout master-<your country alpha3 code>
```

```
git merge farajaland/release-v1.2.*

or 

git merge farajaland/master  (Always aligned to the latest release)
```

```
yarn --force
```

7\. _(Optional: if you are actively developing new features in your country configuration)_ Checkout and merge your **master-\<your country code>** branch onto any other Git branches that are appropriate to you such as **develop-\<your country code>** . **Then checkout back to your master-\<your country code> branch before proceeding!**

8\. If you are running OpenCRVS locally, simply [start OpenCRVS](../../setup/3.-installation/3.1-set-up-a-development-environment/3.1.3-starting-and-stopping-opencrvs.md).  Migrations will automatically run on your data and you have finished upgrading OpenCRVS locally.  Proceed to the next section if you have already deployed OpenCRVS to a remote server cluster.

****

### Step 2: Upgrade your server **environments**

{% hint style="danger" %}
If you have hosted **AND CONFIGURED** OpenCRVS on a server and are capturing live registrations in production, **YOU MUST:** [**make an emergency backup of your data before proceeding**](../../setup/3.-installation/3.3-set-up-a-server-hosted-environment/3.3.7-automated-backup-and-restore-optional-external-backups.md) so that you can restore in the event of any migration problems. **THIS BACKUP MUST BE DOWNLOADED, SO YOU HAVE A 2ND COPY STORED EXTERNALLY FROM YOUR SERVER BEFORE PROCEEDING.**
{% endhint %}

{% hint style="danger" %}
In OpenCRVS v1.2.0 we have some large data migrations to run.  If you have been running OpenCRVS with many live registrations, these migrations may take several hours to complete.  This will lead to reduced performance of OpenCRVS during this time. Therefore we recommend performing a server migration outside of office hours.
{% endhint %}

1. If you have hosted OpenCRVS on a server, and you have a backup of your configuration, you must first take your environment down. SSH into your master node and run:

```
docker stack down opencrvs
```

2\. Restart the Docker service

```
service docker restart
```

3\. Exit your server:

```
exit
```

4\. Run the Ansible scripts again [**depending on your set up**](../../setup/3.-installation/3.3-set-up-a-server-hosted-environment/3.3.2-install-dependencies.md).  **You run these scripts locally from the opencrvs-core master branch inside the infrastructure/server-setup folder.** &#x20;

```
cd <path on your local computer>/opencrvs-core/infrastructure/server-setup
```

```
ansible-playbook -i <inventory_file> <playbook_file> -e " \
dockerhub_username=<your dockerhub username> \
dockerhub_password=<your dockerhub password> \
mongodb_admin_username=<mongo username> \
mongodb_admin_password=<mongo password you generated> \
elasticsearch_superuser_password=<elastic password you generated> \
disk_encryption_key=<a strong disk encryption password> \
country_config_path=<local path to your country config folder> \
encrypt_data=True"
```

###

5\. Deploy v1.2\*.  If you have hosted OpenCRVS on a server, [build your country configuration Docker image and deploy using the githash or tag created for your country configuration and the tag **v1.2.\*** for your core image.](../../setup/3.-installation/3.3-set-up-a-server-hosted-environment/3.3.6-deploy.md)  Migrations will automatically run on your data.

6\. You can check the progress status of your migrations in Kibana. &#x20;



\===== TODO =====

<figure><img src="../../.gitbook/assets/Screenshot 2022-09-22 at 10.15.59.png" alt=""><figcaption></figcaption></figure>

