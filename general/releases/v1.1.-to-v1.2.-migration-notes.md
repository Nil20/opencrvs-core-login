# v1.1.\* to v1.2.\* Migration notes

{% hint style="danger" %}
**v1.2.0-beta is still undergoing migration testing and should not be used in production.** You should not attempt to migrate between v1.1 and v1.2.0-beta.  v1.2.0 will be migration ready at the stable release at the end of January 2023
{% endhint %}

### Step 1: Prepare to migrate

{% hint style="warning" %}
If you are working on behalf of a government that is considering implementing OpenCRVS, we can help you to migrate your version of OpenCRVS.&#x20;

Please contact us at [team@opencrvs.org](mailto:team@opencrvs.org?subject:WebsiteEnquiry)
{% endhint %}

Before you start migrating, consider these questions which we would ask you if we were offering support:

1. What version number you are currently using?
2. What version number you wish to upgrade to?

{% hint style="info" %}
It is not possible to upgrade from v1.0 to v1.2 without first upgrading to v1.1 for example.
{% endhint %}

{% hint style="warning" %}
Are you upgrading from v1.2\* to a newer hotfix of v1.2\*?  If so, you can just pull and merge master with your forks and use the new version in your deploy scripts. You do not need to run any Ansible scripts again on your servers.   **These notes are for users migrating from v1.1 only.**  Ansible changes are not made on any hotfix release.
{% endhint %}

3\. Have you made any NodeJS or React code customisations of any kind to opencrvs-core?

{% hint style="info" %}
Some people make customisations to opencrvs-core which means they need to merge or rebase changes to core as well as the country configuration server.  Normally we do not advise people to make their own core customisations but instead work with our core team to open pull requests on core for any functionality you need.  However some people choose to do this independently, so make sure you also merge/rebase your core repo too.
{% endhint %}

4\. Have you integrated OpenCRVS to another system using an API, or documented system client?

{% hint style="info" %}
As of OpenCRVS 1.2\* we have a new integrations UI and a migration to move existing integrations over.  But we have also refactored the folder structure of our country configuration server considerably. We recommend that you migrate on a Quality Assurance or Staging server and test that your migrations work in a test environment first.  Reach out to us if you need help.
{% endhint %}

5\. Have you completely configured OpenCRVS?

6\. Have you setup real registrar users in the system?

7\. Are you already registering real citizens in testing or production?

8\. Have you deployed OpenCRVS to a server environment? If so, answer these additional questions:

* Please tell us if you have dedicated or shared servers
* Do you have independent development (staging), quality assurance and production servers? Tell us what you have.
* What are the specifications of your servers?
* Are you running OpenCRVS on a cluster of 1, 3 or 5 servers?
* Have you provisioned a backup server and automated emergency backups as documented?
* How much free disk space and RAM is generally available on each server?

{% hint style="info" %}
We ask these questions to make sure that you are aware that you should [backup your data first and ensure that you can restore from a backup](../../setup/3.-installation/3.3-set-up-a-server-hosted-environment/3.3.7-automated-backup-and-restore-optional-external-backups.md). We ask them to make sure you have healthy environments with enough RAM and disk space.  You must test your migration first on a dedicated quality assurance / staging / test server before attempting to migrate a production server.  You need to know that your configurations still work and your data is safe.  If you have concerns, reach out to us for support.
{% endhint %}



### Step 2: Begin the migration locally on your computer first

We have worked hard to ensure that migrating from v1.1 to v1.2.\* is as easy as possible.  The most complex task really depends upon how much customisation you have made to your country configuration fork as you will be required to merge or rebase your fork with our release branch.  **(You must be familiar with the concept of** [**Git merge**](https://git-scm.com/docs/git-merge) **or**  [**Git rebase**](https://www.atlassian.com/git/tutorials/rewriting-history/git-rebase)**)**. Please refer to the [release notes](v1.1.0-release-notes.md) and our [release process including Gitflow](./) branching approach.

{% hint style="info" %}
Replace the \* with the latest minor hotfix release in all the following steps. &#x20;

As of December 2022 the latest release is: **v1.2.0-beta**
{% endhint %}

### Step 3: Upgrade your code

1. Navigate to your opencrvs-core directory, checkout the **release-v1.2.0-beta** or **master** branch and pull latest changes.  Yarn install any dependency upgrades:

```
cd <path on your environment>/opencrvs-core
```

```
git fetch
```

```
git checkout release-v1.2.*

or 

git checkout master (Always aligned to the latest release)
```

```
git pull
```

```
yarn --force
```

2\. You will now have the release code.  Your next step is to merge or rebase any changes you need from the country configuration repository fork.

3\. Navigate to your forked country configuration repo

```
cd <path on your environment>/opencrvs-<your country>
```

4\. Ensure that the branches you have set up are ready according to the new forking instructions [here](../../setup/3.-installation/3.2-set-up-your-own-country-configuration/3.2.1-fork-your-own-country-configuration-repository.md).  Specifically from [step 9 to 17](../../setup/3.-installation/3.2-set-up-your-own-country-configuration/3.2.1-fork-your-own-country-configuration-repository.md).

{% hint style="info" %}
If you have made no customisations to the Farajaland country configuration, other than updating your csv files for [administrative divisions](../../setup/3.-installation/3.2-set-up-your-own-country-configuration/3.2.2-set-up-administrative-address-divisions/), [offices and health facilities](../../setup/3.-installation/3.2-set-up-your-own-country-configuration/3.2.4-set-up-employees-for-testing-or-production/3.2.3.2-prepare-source-file-for-production-employees.md), [employees](../../setup/3.-installation/3.2-set-up-your-own-country-configuration/3.2.4-set-up-employees-for-testing-or-production/) and created new [backups](../../setup/3.-installation/3.2-set-up-your-own-country-configuration/3.2.6-create-factory-reset-reference-data-backups.md), the merge or rebase process should be easy.  If you have customised any routes or developed new API integrations, you may need to be a bit more careful with merging conflicts.
{% endhint %}

5\. Fetch all our latest branches as [**step 17 will have added Farajaland as a remote**](../../setup/3.-installation/3.2-set-up-your-own-country-configuration/3.2.1-fork-your-own-country-configuration-repository.md):

```
git fetch --all
```

6\. Checkout your **master-\<your country code>** branch, and merge or rebase from our release. ****&#x20;

{% hint style="info" %}
**It is generally easier to**[ **merge than rebase (advanced)**](https://www.atlassian.com/git/tutorials/merging-vs-rebasing)**.**
{% endhint %}

{% hint style="warning" %}
Merge/Rebase note: Prioritise your current backup zip files over our incoming Farajaland backups otherwise you will need to [regenerate your backups](../../setup/3.-installation/3.2-set-up-your-own-country-configuration/3.2.6-create-factory-reset-reference-data-backups.md) after the process ends.  Prioritise incoming changes for any other conflicts and refactor your code if you have developed your own customisations. Refer to our [release notes ](v1.2.0-beta-release-notes.md)for hints and any new translation keys that you will need to fix conflicts for.
{% endhint %}

```
git checkout master-<your country alpha3 code>
```

```
git merge farajaland/release-v1.2.*

or 

git merge farajaland/master  (Always aligned to the latest release)
```

```
yarn --force
```

7\. _(Optional: if you are actively developing new features in your country configuration)_ Checkout and merge your **master-\<your country code>** branch onto any other Git branches that are appropriate to you such as **develop-\<your country code>** . **Then checkout back to your master-\<your country code> branch before proceeding!**

8\. If you are running OpenCRVS locally, simply [start OpenCRVS](../../setup/3.-installation/3.1-set-up-a-development-environment/3.1.3-starting-and-stopping-opencrvs.md).  Migrations will automatically run on your data and you have finished upgrading OpenCRVS locally.  Proceed to the next section if you have already deployed OpenCRVS to a remote server cluster.

****

### Step 4: Upgrade your server **environments**

****

Before you commence, ensure that you have followed these warning operational steps:



**Warning 1: Backup and test a restore of your data on a test server**

{% hint style="danger" %}
If you have hosted **AND CONFIGURED** OpenCRVS on a server and are capturing live registrations in production, **YOU MUST:** [**make an emergency backup of your data before proceeding**](../../setup/3.-installation/3.3-set-up-a-server-hosted-environment/3.3.7-automated-backup-and-restore-optional-external-backups.md) so that you can restore in the event of any migration problems. **THIS BACKUP MUST BE DOWNLOADED, SO YOU HAVE A 2ND COPY STORED EXTERNALLY FROM YOUR SERVER BEFORE PROCEEDING.  THIS BACKUP MUST BE RESTORED SUCCESSFULLY ON A QUALITY ASSURANCE / STAGING / TEST SERVER TO ENSURE IT WORKS BEFORE CONTINUING.** &#x20;
{% endhint %}



**Warning 2: Prepare operationally for a migration.  Test the following steps on a test server first. Schedule the production migration when staff can cease operations.** &#x20;

{% hint style="danger" %}
In OpenCRVS v1.2.0 we have some large data migrations to run.  If you have been running OpenCRVS in production and you have live civil registrations for real citizens, these migrations may take several hours to complete.  This will lead to reduced performance of OpenCRVS during this time. Therefore we recommend performing a server migration on an entirely new set of servers that have been restored wth a backup created in Warning 1.  When you have tested your migrated servers and data, you can then change your DNS settings to point to your new server with confidence.  **COMPLETE A MIGRATION ON A TEST SERVER BEFORE RUNNING ON PRODUCTION.  CEASE CIVIL REGISTRATION ACTIVITIES DURING A PRODUCTION MIGRATION. CONSIDER PERFORMING A PRODUCTION MIGRATION DURING NATIONAL HOLIDAYS TO AVOID RISK OF DATA LOSS.**
{% endhint %}

1. If you have hosted an entirely new OpenCRVS on a server, and you have a 2nd copy of the backup of your configuration hosted elsewhere, and you have a successful restoration from that backup running on this server, you must next take your environment down. SSH into your master node and run:

```
docker stack down opencrvs
```

2\. Restart the Docker service

```
service docker restart
```

3\. In OpenCRVS v1.2\* we upgraded [Traefik](https://traefik.io/) to v2.  This requires you to delete the old SSL certificate acme.json. Ansible will create a new one for you in the next step.

```
rm /data/traefik/acme.json
```

4\. Exit your server:

```
exit
```

5\. Run the Ansible scripts again [**depending on your set up**](../../setup/3.-installation/3.3-set-up-a-server-hosted-environment/3.3.2-install-dependencies.md).  **You run these scripts locally from the opencrvs-core master branch inside the infrastructure/server-setup folder.** &#x20;

{% hint style="warning" %}
You must ensure that you are in your local computer and **both** **your local directories opencrvs-core and opencrvs-\<your country> are on the same** _**release-v1.2\***_ or _**master**_ branch before running Ansible.  Ansible is run from your local machine and it connects to your server using SSH and automatically runs commands on it.
{% endhint %}

```
cd <path on your local computer>/opencrvs-core/infrastructure/server-setup
```

```
ansible-playbook -i <inventory_file> <playbook_file> -e " \
dockerhub_username=<your dockerhub username> \
dockerhub_password=<your dockerhub password> \
mongodb_admin_username=<mongo username> \
mongodb_admin_password=<mongo password you generated> \
elasticsearch_superuser_password=<elastic password you generated> \
disk_encryption_key=<a strong disk encryption password> \
country_config_path=<local path to your country config folder> \
encrypt_data=True"
```

6\. If you configured your DNS settings with a wilcard, e.g. _\*.\<your\_domain>_ then you can continue to the next step.  Otherwise in OpenCRVS v1.2\* we have introduced the following new subdomains, so you must create A records for them as we did in [this step](../../setup/3.-installation/3.3-set-up-a-server-hosted-environment/3.3.5-setup-dns-a-records.md):

_documents.\<your\_domain>_

_minio.\<your\_domain>_

_minio-console.\<your\_domain>_

_ui-kit.\<your\_domain> (previously styleguide.\<your\_domain>)_

7\. Deploy v1.2\*.  If you have hosted OpenCRVS on a server, [build your country configuration Docker image and deploy using the githash or tag created for your country configuration and the tag **v1.2.\*** for your core image.](../../setup/3.-installation/3.3-set-up-a-server-hosted-environment/3.3.6-deploy.md)  Migrations will automatically run on your data.

8\. You can check the progress status of your migrations in Kibana. &#x20;

{% hint style="warning" %}
We have an example production server, in which we have created 50,000 test birth and death registrations.  Migrating the data on that server between v1.1 and v1.2 took 5 hours to complete.  **DO NOT ATTEMPT TO USE OPENCRVS WHILE MIGRATIONS ARE RUNNING**
{% endhint %}

To login to Kibana, visit _https://kibana.\<your\_domain>_ and login using the _**username: "elastic"**_ and the _**ELASTICSEARCH\_SUPERUSER\_PASSWORD**_ you configured in [this step](../../setup/3.-installation/3.3-set-up-a-server-hosted-environment/3.3.6-deploy.md).

In the left navigation, select **"Observability"**, then **"Logs"**

In the search bar, enter this text: **"tag: migration"**

Click the **"Stream live"** button for live output from the migration microservice.  You will see output like this, potentially for many hours!!!

<figure><img src="../../.gitbook/assets/Screenshot 2023-01-03 at 15.36.59.png" alt=""><figcaption><p>v1.1* to v1.2* migrations running</p></figcaption></figure>

9\. When the migrations are completed, you can login to OpenCRVS and test v1.2.  When you are satisfied, consider scheduling the production migration and follow the same steps.
